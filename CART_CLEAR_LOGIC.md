# Логика очистки корзины после оплаты

## Как это работает

Корзина пользователя автоматически очищается после **успешной оплаты** заказа через Stripe.

## Реализация

### Webhook обработчик

Очистка корзины происходит в [stripeWebhookController.js](controllers/stripeWebhookController.js) в трёх местах:

1. **`handleCheckoutSessionCompleted`** - при немедленной успешной оплате
   ```javascript
   if (session.payment_status === 'paid') {
       // ... обновление заказа ...

       // Очистка корзины
       const userId = order.userId;
       if (userId) {
           const deletedCount = await CartProduct.destroy({
               where: { userId }
           });
           console.log(`Cleared ${deletedCount} items from cart for user ${userId}`);
       }
   }
   ```

2. **`handleCheckoutSessionAsyncPaymentSucceeded`** - при асинхронной успешной оплате
   - Например, для банковских переводов или других методов оплаты с задержкой

3. **`handlePaymentIntentSucceeded`** - дополнительный обработчик успешной оплаты
   - Срабатывает при успешном завершении платёжного намерения

## События Stripe

Корзина очищается при получении следующих webhook событий:

- ✅ `checkout.session.completed` (payment_status = 'paid')
- ✅ `checkout.session.async_payment_succeeded`
- ✅ `payment_intent.succeeded`

## Что происходит при оплате

### Шаг 1: Пользователь оформляет заказ
1. Фронтенд отправляет POST запрос на `/api/order/create`
2. Создается Order с состоянием `pending`
3. Создаются OrderProduct записи (копии товаров из корзины)
4. Возвращается URL для оплаты в Stripe

### Шаг 2: Пользователь оплачивает заказ
1. Пользователь переходит на Stripe Checkout
2. Вводит данные карты и оплачивает
3. Stripe отправляет webhook на `/api/stripe/webhook`

### Шаг 3: Webhook обрабатывает успешную оплату
1. Проверяется подпись webhook
2. Обновляется статус заказа на `confirmed`
3. Сохраняется информация о налоге и итоговой сумме
4. **Корзина пользователя полностью очищается**
5. **Уменьшаются остатки товаров на складе:**
   - Для eBay товаров (`isManual = false`) → `count = 0`
   - Для ручных товаров (`isManual = true`) → `count -= заказанное количество`

## Важные моменты

### 1. Товары сохранены в OrderProduct
Перед очисткой корзины все товары уже сохранены в таблице `order_products`, поэтому информация о заказе не теряется.

### 2. Очистка происходит только при успешной оплате
Если оплата не прошла (`payment_failed`, `expired`, `canceled`), корзина **не очищается**.

### 3. Очищается вся корзина пользователя
Удаляются **все** товары из корзины пользователя, а не только те, что были в заказе.

Это правильное поведение, так как:
- Обычно пользователь оформляет весь содержимое корзины
- После оплаты корзина должна быть пустой для новых покупок

### 4. Webhook должен быть настроен
Для работы очистки корзины необходимо:
- Настроить webhook в Stripe Dashboard
- Установить `STRIPE_WEBHOOK_SECRET` в `.env`
- Убедиться, что endpoint доступен: `https://your-domain.com/api/stripe/webhook`

## Альтернативный подход (не реализован)

Можно также очистить корзину **сразу после создания заказа** (не дожидаясь webhook):

```javascript
// В publicOrderController.js после создания OrderProduct
await CartProduct.destroy({ where: { userId } });
```

**Минусы этого подхода:**
- Если пользователь не завершит оплату, корзина уже будет пустой
- Пользователь потеряет товары если передумает платить

**Текущий подход лучше**, так как:
- ✅ Корзина сохраняется до успешной оплаты
- ✅ Пользователь может вернуться к корзине если оплата не прошла
- ✅ Очистка происходит только при подтверждённом платеже

## Логи

При очистке корзины в консоль выводится:
```
Cleared 5 items from cart for user 123
```

Это помогает отслеживать, что корзина была успешно очищена.

## Тестирование

### Тест успешной оплаты:

1. Добавьте товары в корзину
2. Оформите заказ
3. Оплатите тестовой картой: `4242 4242 4242 4242`
4. Проверьте корзину - она должна быть пустой

### Тест неудачной оплаты:

1. Добавьте товары в корзину
2. Оформите заказ
3. Закройте страницу оплаты (не завершайте оплату)
4. Проверьте корзину - товары должны остаться

### SQL запрос для проверки:

```sql
-- Проверить корзину пользователя
SELECT * FROM "cartProducts" WHERE "userId" = 123;

-- Проверить историю заказов
SELECT id, state, sum, tax, total, "createdAt"
FROM orders
WHERE "userId" = 123
ORDER BY "createdAt" DESC;
```

## Безопасность

- Webhook проверяет подпись Stripe перед обработкой
- Только настоящие события от Stripe могут вызвать очистку корзины
- Невозможно подделать webhook без знания `STRIPE_WEBHOOK_SECRET`
